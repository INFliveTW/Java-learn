å°‡ä»¥ä¸‹ç¨‹å¼æ–°å¢


å¯¦ä½œå–®å…ƒæ¸¬è©¦èˆ‡æ•´åˆæ¸¬è©¦ï¼ˆJUnitï¼‰

ä½¿ç”¨ Mock æ¡†æ¶æ¨¡æ“¬å¤–éƒ¨ API è«‹æ±‚ï¼ˆå¦‚ WebTestClient æˆ– WireMockï¼‰

ä¸¦çµ¦äºˆè©³ç´°èªªæ˜èˆ‡æ¸¬è©¦æ–¹å¼ç­‰...

<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>

schedulerå…§å®¹
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”‚   â””â”€â”€ cdf/training/bch/scheduler/
â”‚   â”‚   â”‚       â”œâ”€â”€ SchedulerApplication      # ä¸»æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é¡
â”‚   â”‚   â”‚       â”œâ”€â”€ config/                   # é…ç½®é¡
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ APIProperties # API URL
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ErrorMessage # éŒ¯èª¤è™•ç†(é›†ä¸­)
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ GlobalExceptionHandler # ç•°å¸¸è™•ç†(å‘¼å«apiæ™‚ç™¼ç”Ÿç•°å¸¸)
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ WebClientConfig      # WebClient é…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ service/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€  DatatransferService #å‘¼å«datatransferçš„APIå»æå–sftpçš„è³‡æ–™
â”‚   â”‚   â”‚       â””â”€â”€ util/                   # å·¥å…·é¡
â”‚   â”‚   â”‚           â””â”€â”€ WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®
â””â”€â”€ build.gradle                             # ä¾è³´ç®¡ç†

<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>

datatransferå…§å®¹
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”‚   â””â”€â”€ cdf/training/svc/datatransfer/
â”‚   â”‚   â”‚       â”œâ”€â”€ DatatransferApplication   # ä¸»æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é¡
â”‚   â”‚   â”‚       â”œâ”€â”€ config/                   # é…ç½®é¡
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DatabaseConfig       # è³‡æ–™åº«é…ç½®
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ErrorMessage         # éŒ¯èª¤è™•ç†(é›†ä¸­)
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ SFTPConfig           # SFTP å®¢æˆ¶ç«¯é…ç½®
â”‚   â”‚   â”‚       â”œâ”€â”€ controller/              # REST API æ§åˆ¶å™¨
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ EmployeeDataController       #(è¢«å‘¼å«æ™‚åŸ·è¡Œå®Œæˆè¿”å›è³‡æ–™çµ¦scheduler)
â”‚   â”‚   â”‚       â”œâ”€â”€ dto/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ CSVToDataBaseResponseDto # Response (å‘¼å«è«‹æ±‚)
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ CSVToDataBaseRequestDto # Request(å›æ‡‰è«‹æ±‚) Schedulerå‘¼å«controllerå¾Œå›å‚³æ­¤â”‚   â”‚   â”‚       â”‚   â””â”€â”€ EmployeeDataCSVDto     #SFTPçš„CSV
â”‚   â”‚   â”‚       â”œâ”€â”€entity/                      # è³‡æ–™æ¨¡å‹
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ EmployeeDataEntity      # å°æ‡‰è³‡æ–™åº«è¡¨çš„å¯¦é«”
â”‚   â”‚   â”‚       â”œâ”€â”€ repository/             # è³‡æ–™åº«å­˜å–å±¤
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ EmployeeDataRepository      # JPA æˆ– JDBC å­˜å–è³‡æ–™åº«
â”‚   â”‚   â”‚       â”œâ”€â”€ service/                # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ impl/
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ CSVToDataBaseService         #SFTPè®€å– > csvè§£æ  > sqlå¯«å…¥ //try-catch error
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ DataConverterImpl # EmployeeDataCSVDtoè½‰æ›csvè³‡æ–™
â”‚   â”‚   â”‚       â”‚       â””â”€â”€ SFTPServiceImpl # SFTP è®€å–
â”‚   â”‚   â”‚       â””â”€â”€ util/                   # å·¥å…·é¡
â”‚   â”‚   â”‚           â”œâ”€â”€ CSVParserUtil       # CSV è§£æå·¥å…·
â”‚   â”‚   â”‚           â””â”€â”€ WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ java/
â”‚           â””â”€â”€ cdf/training/svc/datatransfer
â”‚               â””â”€â”€ # å–®å…ƒæ¸¬è©¦
â””â”€â”€ build.gradle

<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>

---------------------
å…ˆçµ¦schedulerå…§å®¹
---------------------

------------------------------------------
ã€SchedulerApplicationã€‘
------------------------------------------

------------------------------------------
config/
ã€APIProperties # API URLã€‘
------------------------------------------

------------------------------------------
config/
ã€ErrorMessage # éŒ¯èª¤è™•ç†(é›†ä¸­)ã€‘
------------------------------------------

------------------------------------------
config/
ã€GlobalExceptionHandler # ç•°å¸¸è™•ç†(å‘¼å«apiæ™‚ç™¼ç”Ÿç•°å¸¸)ã€‘
------------------------------------------

------------------------------------------
config/
ã€WebClientConfig      # WebClient é…ç½®ã€‘
------------------------------------------

------------------------------------------
service/
ã€DatatransferService #å‘¼å«datatransferçš„APIå»æå–sftpçš„è³‡æ–™ã€‘
------------------------------------------

------------------------------------------
util/
ã€WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£ã€‘
------------------------------------------

------------------------------------------
resources/
ã€application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®ã€‘
------------------------------------------

------------------------------------------
ã€build.gradleã€‘
------------------------------------------


---------------------
å†çµ¦datatransferå…§å®¹
---------------------

------------------------------------------
ã€DatatransferApplicationã€‘
------------------------------------------

------------------------------------------
config/
ã€DatabaseConfig       # è³‡æ–™åº«é…ç½®ã€‘
------------------------------------------

------------------------------------------
config/
ã€ErrorMessage         # éŒ¯èª¤è™•ç†(é›†ä¸­)ã€‘
------------------------------------------

------------------------------------------
config/
ã€SFTPConfig           # SFTP å®¢æˆ¶ç«¯é…ç½®ã€‘
------------------------------------------

------------------------------------------
controller/ 
ã€EmployeeDataController       #(è¢«å‘¼å«æ™‚åŸ·è¡Œå®Œæˆè¿”å›è³‡æ–™çµ¦scheduler)ã€‘
------------------------------------------

------------------------------------------
dto/
ã€CSVToDataBaseResponseDto # Response (å‘¼å«è«‹æ±‚)ã€‘
------------------------------------------

------------------------------------------
dto/
ã€CSVToDataBaseRequestDto # Request(å›æ‡‰è«‹æ±‚) Schedulerå‘¼å«controllerå¾Œå›å‚³æ­¤ã€‘
------------------------------------------

------------------------------------------
dto/
ã€EmployeeDataCSVDto     #SFTPçš„CSVã€‘
------------------------------------------

------------------------------------------
entity/
ã€EmployeeDataEntity      # å°æ‡‰è³‡æ–™åº«è¡¨çš„å¯¦é«”ã€‘
------------------------------------------

------------------------------------------
repository/
ã€EmployeeDataRepository      # JPA æˆ– JDBC å­˜å–è³‡æ–™åº«ã€‘
------------------------------------------

------------------------------------------
service/
impl/
ã€CSVToDataBaseService         #SFTPè®€å– > csvè§£æ  > sqlå¯«å…¥ //try-catch errorã€‘
------------------------------------------

------------------------------------------
service/
impl/
ã€DataConverterImpl # EmployeeDataCSVDtoè½‰æ›csvè³‡æ–™ã€‘
------------------------------------------

------------------------------------------
service/
impl/
ã€SFTPServiceImpl # SFTP è®€å–ã€‘
------------------------------------------

------------------------------------------
util/
ã€CSVParserUtil       # CSV è§£æå·¥å…·ã€‘
------------------------------------------

------------------------------------------
util/
ã€WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£ã€‘
------------------------------------------

------------------------------------------
resources/
ã€application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®ã€‘
------------------------------------------

------------------------------------------
ã€build.gradleã€‘
------------------------------------------

<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>
<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>
<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>

---------------------
å…ˆçµ¦schedulerå…§å®¹
---------------------

------------------------------------------
ã€SchedulerApplicationã€‘
------------------------------------------
package cdf.training.bch.scheduler;

import java.io.PrintStream;
import java.io.UnsupportedEncodingException;
import java.nio.charset.Charset;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SchedulerApplication {
    public static void main(String[] args) throws UnsupportedEncodingException {
        System.setOut(new PrintStream(System.out, true, "UTF-8"));
        System.out.println("Current encoding: " + Charset.defaultCharset().name());
        SpringApplication.run(SchedulerApplication.class, args);
    }
}
------------------------------------------
config/
ã€APIProperties # API URLã€‘
------------------------------------------
package cdf.training.bch.scheduler.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

import lombok.Data;

@Data // Lombok æä¾›çš„ @Data æ³¨è§£ï¼Œè‡ªå‹•ç”Ÿæˆ getter/setter ç­‰æ–¹æ³•
@Component // æ·»åŠ æ­¤æ³¨è§£ä½¿å…¶æˆç‚º Spring Bean
@ConfigurationProperties(prefix = "spring.scheduler.api")
public class APIProperties {
    private String url;
    private int timeout;
    private String timeoutMessage;
}
------------------------------------------
config/
ã€ErrorMessage # éŒ¯èª¤è™•ç†(é›†ä¸­)ã€‘
------------------------------------------
package cdf.training.bch.scheduler.config;

import lombok.Data;

@Data
public class ErrorMessage {
    private int status;
    private String message;
    public ErrorMessage(int status, String message) {
        this.status = status;
        this.message = message;
    }
}

------------------------------------------
config/
ã€GlobalExceptionHandler # ç•°å¸¸è™•ç†(å‘¼å«apiæ™‚ç™¼ç”Ÿç•°å¸¸)ã€‘
------------------------------------------
package cdf.training.bch.scheduler.config;

import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import reactor.core.publisher.Mono;

@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(WebClientResponseException.class)
    public Mono<ResponseEntity<ErrorMessage>> handleWebClientException(WebClientResponseException ex) {
        HttpStatusCode statusCode = ex.getStatusCode();
        HttpStatus status = HttpStatus.valueOf(statusCode.value());

        String errorMessage;
        System.err.println("response: " + ex.getResponseBodyAsString());

        if (status.is4xxClientError()) {
            if (status.value() == 400) {
                System.out.println();
                System.out.println("400éŒ¯èª¤è¨Šæ¯ï¼š");
                errorMessage = "æ ¼å¼éŒ¯èª¤/åƒæ•¸é©—è­‰å¤±æ•—";
            } else if (status.value() == 404) {
                System.out.println("404éŒ¯èª¤è¨Šæ¯ï¼š");
                errorMessage = "æ‰¾ä¸åˆ°æª”æ¡ˆ";
            } else {
                errorMessage = "å®¢æˆ¶ç«¯éŒ¯èª¤: " + status.value();
            }
        } else if (status.is5xxServerError()) {
            errorMessage = "ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
        } else {
            errorMessage = "ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡";
        }
        System.out.println("éŒ¯èª¤status: " + status);
        System.out.println("éŒ¯èª¤statusvalue: " + status.value());
        ErrorMessage error = new ErrorMessage(status.value(), errorMessage);
        
        System.out.println("éŒ¯èª¤è¨Šæ¯: " + error);
        return Mono.just(ResponseEntity.status(status).body(error));
    }
}
------------------------------------------
config/
ã€WebClientConfig      # WebClient é…ç½®ã€‘
------------------------------------------
package cdf.training.bch.scheduler.config;

import java.time.Duration;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.web.reactive.function.client.WebClient;

import reactor.netty.http.client.HttpClient;

@Configuration //é…ç½®é¡ï¼Œå®šç¾©Bean
//SchedulerApplicationæƒæç›¸é—œ
public class WebClientConfig {
    private final APIProperties apiProperties;
    //æ³¨å…¥apiProperties
    //å¾application.ymlè®€å–timeout
    
    public WebClientConfig(APIProperties apiProperties) {
        this.apiProperties = apiProperties;
    }
    //@Beanï¼šå®šç¾© WebClient çš„ Bean

    @Bean
    public WebClient webClient() {
        HttpClient httpClient = HttpClient.create()
                .responseTimeout(Duration.ofSeconds(apiProperties.getTimeout())); // å¾ APIProperties ç²å– timeout
        //ç²å–timeout: 3ç§’
        //å½±éŸ¿DatatransferServiceçš„APIå‘¼å«

        return WebClient.builder()
                .clientConnector(new ReactorClientHttpConnector(httpClient))
                .build();
        //ç”¨ä¾†æ§‹å»º WebClient
    }
}

------------------------------------------
service/
ã€DatatransferService #å‘¼å«datatransferçš„APIå»æå–sftpçš„è³‡æ–™ã€‘
------------------------------------------
package cdf.training.bch.scheduler.service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import cdf.training.bch.scheduler.config.APIProperties;
import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;

@Slf4j
@Service //æ¨™è¨˜æœå‹™é¡å‹
@EnableScheduling //å•Ÿç”¨å®šæ™‚ä»»å‹™(5ç§’)
//@Value //æ­¥é©Ÿ1çš„åˆå§‹åŒ–
public class DatatransferService {
    WebClient webClient;
    APIProperties apiProperties;


    public DatatransferService(WebClient webClient, APIProperties apiProperties) {
        this.webClient = webClient;
        this.apiProperties = apiProperties;
    }
    
    @Scheduled(fixedRateString = "${spring.scheduler.interval}000") //æ¯äº”ç§’åŸ·è¡Œ(intervalåœ¨application.yml)
    public void callDatatransferApi() {
        String randomCompany = List.of("é‡‘æ§", "éŠ€è¡Œ", "è­‰åˆ¸").get(new Random().nextInt(3));
        //éš¨æ©Ÿé¸æ“‡ä»»ä¸€å…¬å¸
        Map<String, String> requestBody = Map.of(
                "COMPANY", randomCompany,
                "EXCUTE_TIME", LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd hh:mm:ss"))
        );
        log.info("ğŸ” API URL: {}", apiProperties.getUrl());
        
        webClient.post()
                .uri(apiProperties.getUrl()) //ç›®æ¨™URL
                .bodyValue(requestBody)
                .retrieve()
                .bodyToMono(String.class) //ç²å–å›æ‡‰
                .onErrorResume(throwable -> { //éŒ¯èª¤è™•ç†
                    log.error("ğŸš¨ API å‘¼å«å¤±æ•—ï¼š" + throwable.getMessage());
                    log.info("ğŸ” API URL: {}", apiProperties.getUrl());

                    // return Mono.just(apiProperties.getTimeoutMessage());
                
                    if(throwable instanceof java.util.concurrent.TimeoutException) {
                        return  Mono.just(apiProperties.getTimeoutMessage());
                    }
                    return Mono.just(apiProperties.getTimeoutMessage());
                })
                .subscribe(result -> System.out.println("API å›æ‡‰ï¼š"+ result));
    }
}

------------------------------------------
util/
ã€WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£ã€‘
------------------------------------------
package cdf.training.bch.scheduler.util; 

public class WebClientUtil {

}
------------------------------------------
resources/
ã€application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®ã€‘
------------------------------------------
spring:
  application:
    name: training-bch-scheduler

  scheduler:
    interval: 5 #å¹¾ç§’å‘¼å«ä¸€æ¬¡API
    api:
      url: "http://localhost:8081/api/employee-data"
      # http://localhost:8081/api/employee-data?Content-Type=application/json
      timeout: 3 #APIå‘¼å«è¶…æ™‚æ™‚é–“
      timeout-message: "å›è¦†æ™‚é–“éé•·ï¼Œè«‹ç¨å¾Œå†è©¦ï¼"

logging:
  charset:
    console: UTF-8
      # æ­¥é©Ÿ4ï¼šDatatransferæ¥æ”¶
      # æä¾›é…ç½®çµ¦ APIProperties å’Œ DatatransferServiceï¼Œæ­¥é©Ÿ1
------------------------------------------
ã€build.gradleã€‘
------------------------------------------
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.4.3'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'cdf.training.bch'
version = '1.0.0-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(23)
	}
}

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-actuator'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

bootRun {
    jvmArgs = ['-Dfile.encoding=UTF-8', '-Dconsole.encoding=UTF-8']
}

tasks.named('test') {
	useJUnitPlatform()
}


<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>


---------------------
å†çµ¦datatransferå…§å®¹
---------------------

------------------------------------------
ã€DatatransferApplicationã€‘
------------------------------------------
package cdf.training.svc.datatransfer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class DatatransferApplication {

	public static void main(String[] args) {
		SpringApplication.run(DatatransferApplication.class, args);
	}

}

------------------------------------------
config/
ã€DatabaseConfig       # è³‡æ–™åº«é…ç½®ã€‘
------------------------------------------
// package cdf.training.svc.datatransfer.config;

// import org.springframework.context.annotation.Configuration;

// @Configuration
// public class DatabaseConfig {
//     // ç›®å‰ç„¡éœ€é¡å¤–é…ç½®ï¼ŒJdbcTemplate æœƒè‡ªå‹•ä½¿ç”¨ application.yml çš„ datasource
//     // å¯åœ¨æ­¤æ·»åŠ å…¶ä»– JDBC ç›¸é—œé…ç½®ï¼ˆå¦‚ DataSource å®¢è£½åŒ–ï¼‰ï¼Œä½†é€™è£¡ç•™ç©ºå³å¯
// }
package cdf.training.svc.datatransfer.config;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan(basePackages = "cdf.training.svc.datatransfer.repository")
public class DatabaseConfig {

}
// @MapperScanï¼šå‘Šè¨´ MyBatis æƒææŒ‡å®šçš„ Mapper æ¥å£è·¯å¾‘ï¼ˆé€™è£¡æ˜¯ repository åŒ…ï¼‰ã€‚
// ç§»é™¤ JPA é…ç½®ï¼šä¸å†éœ€è¦ @EnableJpaRepositoriesã€‚
------------------------------------------
config/
ã€ErrorMessage         # éŒ¯èª¤è™•ç†(é›†ä¸­)ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.config;

import lombok.Data;

@Data
public class ErrorMessage {
    private int status;
    private String message;
    public ErrorMessage(int status, String message) {
        this.status = status;
        this.message = message;
    }
}
------------------------------------------
config/
ã€SFTPConfig           # SFTP å®¢æˆ¶ç«¯é…ç½®ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;

import lombok.Data;

@Data
@Configuration
@ConfigurationProperties(prefix = "sftp")
public class SFTPConfig {
    private String host;
    private int port;
    private String username;
    private String password;
    private String remoteDir;
}
------------------------------------------
controller/ 
ã€EmployeeDataController       #(è¢«å‘¼å«æ™‚åŸ·è¡Œå®Œæˆè¿”å›è³‡æ–™çµ¦scheduler)ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.controller;

import java.time.Duration;
import java.time.Instant;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import cdf.training.svc.datatransfer.dto.CSVToDataBaseRequestDto;
import cdf.training.svc.datatransfer.dto.CSVToDataBaseResponseDto;
import cdf.training.svc.datatransfer.service.impl.CSVToDataBaseServiceImpl;

@RestController //æ¨™è¨˜ç‚º REST æ§åˆ¶å™¨
@RequestMapping("/api")
public class EmployeeDataController {
    private final CSVToDataBaseServiceImpl csvToDataBaseService;

    public EmployeeDataController(CSVToDataBaseServiceImpl csvToDataBaseService) {
        this.csvToDataBaseService = csvToDataBaseService;
    }
    
    @PostMapping("/employee-data") //è™•ç† POSTè«‹æ±‚
    public ResponseEntity<CSVToDataBaseResponseDto> processEmployeeData(@RequestBody CSVToDataBaseRequestDto request) {
        // è¨˜éŒ„ API å‘¼å«å‰çš„æ™‚é–“
        Instant startTime = Instant.now();
        System.out.println("å‘¼å« API å‰æ™‚é–“: " + startTime);

        csvToDataBaseService.processCsvToDatabase(request); //èª¿ç”¨æœå‹™è™•ç†

        // è¨˜éŒ„ API å‘¼å«å¾Œçš„æ™‚é–“
        Instant endTime = Instant.now();
        System.out.println("å‘¼å« API å¾Œæ™‚é–“: " + endTime);

        // è¨ˆç®—æ™‚é–“å·® (ä»¥ç§’ç‚ºå–®ä½)
        Duration duration = Duration.between(startTime, endTime);
        double seconds = duration.toMillis() / 1000.0;
        System.out.println("API å‘¼å«è€—æ™‚: " + seconds + " ç§’");
        
        return ResponseEntity.ok(new CSVToDataBaseResponseDto("è³‡æ–™è™•ç†æˆåŠŸ"));
    }
}
//æ­¥é©Ÿ5ï¼šæ¥æ”¶è«‹æ±‚
------------------------------------------
dto/
ã€CSVToDataBaseResponseDto # Response (å‘¼å«è«‹æ±‚)ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.dto;

import lombok.Data;

@Data
public class CSVToDataBaseRequestDto {
    private String COMPANY;
    private String EXCUTETIME;
}
------------------------------------------
dto/
ã€CSVToDataBaseRequestDto # Request(å›æ‡‰è«‹æ±‚) Schedulerå‘¼å«controllerå¾Œå›å‚³æ­¤ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.dto;

import lombok.Data;

@Data
public class   CSVToDataBaseResponseDto {
    private String message;

    public CSVToDataBaseResponseDto(String message) {
        this.message = message;
    }
}
------------------------------------------
dto/
ã€EmployeeDataCSVDto     #SFTPçš„CSVã€‘
------------------------------------------
package cdf.training.svc.datatransfer.dto;

import java.time.LocalDateTime;

import lombok.Data;

@Data
public class EmployeeDataCSVDto {
    private String ID;
    private String DEPARTMENT;
    private String JOB_TITLE;
    private String NAME;
    private String TEL;
    private String EMAIL;
    private String COMPANY;      // æ–°å¢æ¬„ä½
    private LocalDateTime EXCUTETIME; // æ–°å¢æ¬„ä½
}
------------------------------------------
entity/
ã€EmployeeDataEntity      # å°æ‡‰è³‡æ–™åº«è¡¨çš„å¯¦é«”ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.entity;

import java.time.LocalDateTime;

import lombok.Data;

@Data
public class EmployeeDataEntity {
    private String ID; // CSV ä¸­çš„ IDï¼Œæ™®é€šæ¬„ä½
    private String DEPARTMENT;
    private String JOB_TITLE;
    private String NAME;
    private String TEL;
    private String EMAIL;
    private String COMPANY;
    private LocalDateTime EXCUTETIME;
}
//ä¸éœ€è¦ @Entity æˆ– @Idï¼Œå› ç‚º MyBatis ä¸ä¾è³´ JPA çš„æ³¨è§£ï¼Œè€Œæ˜¯ä¸€å€‹ç´”æ•¸æ“šç‰©ä»¶ï¼ˆPOJOï¼‰ã€‚
------------------------------------------
repository/
ã€EmployeeDataRepository      # JPA æˆ– JDBC å­˜å–è³‡æ–™åº«ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.repository;

//import org.springframework.data.jpa.repository.JpaRepository;

import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;

import cdf.training.svc.datatransfer.entity.EmployeeDataEntity;

@Mapper
public interface EmployeeDataRepository {
    @Insert("INSERT INTO employee_data (ID, DEPARTMENT, JOB_TITLE, NAME, TEL, EMAIL, COMPANY, EXCUTETIME) " +
            "VALUES (#{ID}, #{DEPARTMENT}, #{JOB_TITLE}, #{NAME}, #{TEL}, #{EMAIL}, #{COMPANY}, #{EXCUTETIME})")
    void insert(EmployeeDataEntity entity);
}
//@Mapperï¼šæ¨™è¨˜é€™æ˜¯ä¸€å€‹ MyBatis Mapper æ¥å£ã€‚
//@Insertï¼šå®šç¾©æ’å…¥ SQLï¼Œ#{} ç”¨æ–¼å¾ EmployeeDataEntity ç‰©ä»¶ä¸­å–å€¼ã€‚
//ç„¡ä¸»éµï¼šMyBatis ä¸è¦æ±‚ä¸»éµï¼Œé€™èˆ‡ä½ çš„éœ€æ±‚ä¸€è‡´ã€‚


//public interface EmployeeDataRepository extends JpaRepository<EmployeeDataEntity, Long> {
//}
------------------------------------------
service/
impl/
ã€CSVToDataBaseService         #SFTPè®€å– > csvè§£æ  > sqlå¯«å…¥ //try-catch errorã€‘
------------------------------------------
package cdf.training.svc.datatransfer.service.impl;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Random;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import cdf.training.svc.datatransfer.dto.CSVToDataBaseRequestDto;
import cdf.training.svc.datatransfer.dto.EmployeeDataCSVDto;
import cdf.training.svc.datatransfer.entity.EmployeeDataEntity;
import cdf.training.svc.datatransfer.repository.EmployeeDataRepository;
import cdf.training.svc.datatransfer.util.CSVParserUtil;

@Service
public class CSVToDataBaseServiceImpl {
    private static final Logger logger = LoggerFactory.getLogger(CSVToDataBaseServiceImpl.class);
    private final SFTPServiceImpl sftpService;
    private final CSVParserUtil csvParserUtil;
    private final DataConverterImpl dataConverter;
    private final EmployeeDataRepository repository;

    public CSVToDataBaseServiceImpl(SFTPServiceImpl sftpService, CSVParserUtil csvParserUtil,
                                    DataConverterImpl dataConverter, EmployeeDataRepository repository) {
        this.sftpService = sftpService;
        this.csvParserUtil = csvParserUtil;
        this.dataConverter = dataConverter;
        this.repository = repository;
    }

    public void processCsvToDatabase(CSVToDataBaseRequestDto request) {
        try {
            String csvContent = sftpService.readFileFromSFTP("/upload/employee_data.csv");
            logger.info("å¾ SFTP è®€å–çš„ CSV å…§å®¹: {}", csvContent);

            List<EmployeeDataCSVDto> csvDtos = csvParserUtil.parseCsv(csvContent);

            String COMPANY = request.getCOMPANY() != null ? request.getCOMPANY() :
                    List.of("é‡‘æ§", "éŠ€è¡Œ", "è­‰åˆ¸").get(new Random().nextInt(3));
            String EXCUTETIMEStr = request.getEXCUTETIME() != null ? request.getEXCUTETIME() :
                    LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
            LocalDateTime EXCUTETIME = LocalDateTime.parse(EXCUTETIMEStr, DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));

            List<EmployeeDataEntity> entities = dataConverter.convertToEntities(csvDtos, COMPANY, EXCUTETIME);

            for (EmployeeDataEntity entity : entities) {
                logger.info("æº–å‚™å¯«å…¥ SQL: ID={}, DEPARTMENT={}, JOB_TITLE={}, NAME={}, TEL={}, EMAIL={}, COMPANY={}, EXCUTETIME={}",
                        entity.getID(), entity.getDEPARTMENT(), entity.getJOB_TITLE(), entity.getNAME(),
                        entity.getTEL(), entity.getEMAIL(), entity.getCOMPANY(), entity.getEXCUTETIME());
                repository.insert(entity); // ä½¿ç”¨ MyBatis æ’å…¥
            }

            logger.info("æˆåŠŸæ–°å¢ {} ç­†è³‡æ–™åˆ°è³‡æ–™åº«", entities.size());

        } catch (Exception e) {
            System.out.println("message : " + e.getMessage());
            String errorMessage = e.getMessage().contains("SFTP") ? "ç„¡æ³•é€£æ¥åˆ° SFTP ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥é…ç½®æˆ–ç¶²è·¯ç‹€æ…‹" :
                    e.getMessage().contains("parse") ? "CSV æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º" :
                            e.getMessage().contains("database") ? "è³‡æ–™åº«å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£ç·šæˆ–æ¬Šé™" :
                                    "ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼š" + e.getMessage();
            logger.error("å°‡ CSV å‚³è¼¸åˆ°è³‡æ–™åº«æ™‚å‡ºéŒ¯: {}", errorMessage);
            throw new RuntimeException(errorMessage, e);
        }
    }
}
//æ­¥é©Ÿ6ï¼šSFTPè®€å–
------------------------------------------
service/
impl/
ã€DataConverterImpl # EmployeeDataCSVDtoè½‰æ›csvè³‡æ–™ã€‘
------------------------------------------
// package cdf.training.svc.datatransfer.service.impl;

// import java.time.LocalDateTime;
// import java.util.List;
// import java.util.stream.Collectors;

// import org.springframework.stereotype.Component;

// import cdf.training.svc.datatransfer.dto.EmployeeDataCSVDto;

// @Component
// public class DataConverterImpl {
//     public List<EmployeeDataCSVDto> enrichCsvData(List<EmployeeDataCSVDto> dtos, String COMPANY, LocalDateTime EXCUTETIME) {
//         return dtos.stream().map(dto -> {
//             // ç›´æ¥åœ¨ DTO ä¸Šè¨­ç½® COMPANY å’Œ EXCUTETIME
//             dto.setCOMPANY(COMPANY);      // å‡è¨­åœ¨ EmployeeDataCSVDto ä¸­æ–°å¢æ­¤æ¬„ä½
//             dto.setEXCUTETIME(EXCUTETIME); // å‡è¨­åœ¨ EmployeeDataCSVDto ä¸­æ–°å¢æ­¤æ¬„ä½
//             return dto;
//         }).collect(Collectors.toList());
//     }
// }
package cdf.training.svc.datatransfer.service.impl;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.stereotype.Component;

import cdf.training.svc.datatransfer.dto.EmployeeDataCSVDto;
import cdf.training.svc.datatransfer.entity.EmployeeDataEntity;

@Component
public class DataConverterImpl {
    public List<EmployeeDataEntity> convertToEntities(List<EmployeeDataCSVDto> dtos, String COMPANY, LocalDateTime EXCUTETIME) {
        return dtos.stream().map(dto -> {
            EmployeeDataEntity entity = new EmployeeDataEntity();
            entity.setID(dto.getID());
            entity.setDEPARTMENT(dto.getDEPARTMENT());
            entity.setJOB_TITLE(dto.getJOB_TITLE());
            entity.setNAME(dto.getNAME());
            entity.setTEL(dto.getTEL());
            entity.setEMAIL(dto.getEMAIL());
            entity.setCOMPANY(COMPANY);
            entity.setEXCUTETIME(EXCUTETIME);
            return entity;
        }).collect(Collectors.toList());
    }
}
------------------------------------------
service/
impl/
ã€SFTPServiceImpl # SFTP è®€å–ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.service.impl;

import java.io.InputStream;

import org.springframework.stereotype.Service;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.Session;

import cdf.training.svc.datatransfer.config.SFTPConfig;

@Service
public class SFTPServiceImpl {
    private final SFTPConfig sftpConfig;
    //æ³¨å…¥SFTP
    public SFTPServiceImpl(SFTPConfig sftpConfig) {
        this.sftpConfig = sftpConfig;
    }

    public String readFileFromSFTP(String filePath) {
        //è®€å–SFTP
        try {
            JSch jsch = new JSch();
            //åˆå§‹åŒ– JSch
            Session session = jsch.getSession(sftpConfig.getUsername(), sftpConfig.getHost(), sftpConfig.getPort());
            //å»ºç«‹SFTP (ä½¿ç”¨ SFTPConfigé…ç½®)
            session.setPassword(sftpConfig.getPassword());
            session.setConfig("StrictHostKeyChecking", "no");
            session.connect();
            //é€£ç·šåˆ°SFTP
            ChannelSftp channel = (ChannelSftp) session.openChannel("sftp");
            channel.connect(); //é–‹å•ŸSFTPé€šé“
            InputStream inputStream = channel.get(filePath);
            String content = new String(inputStream.readAllBytes());
            channel.disconnect();
            session.disconnect(); //é—œé–‰é€£ç·š
            return content;
        } catch (Exception e) {
            throw new RuntimeException("SFTP error: " + e.getMessage(), e);
        }
    }
}
//æ­¥é©Ÿ7ï¼šSFTPè™•ç†
------------------------------------------
util/
ã€CSVParserUtil       # CSV è§£æå·¥å…·ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.util;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import cdf.training.svc.datatransfer.dto.EmployeeDataCSVDto;

@Component
public class CSVParserUtil {
    private static final Logger logger = LoggerFactory.getLogger(CSVParserUtil.class);
    
    public List<EmployeeDataCSVDto> parseCsv(String csvContent) {
        List<String> lines = Arrays.asList(csvContent.split("\n"));
        if (lines.isEmpty()) {
            throw new IllegalArgumentException("CSV å…§å®¹ç‚ºç©º");
        }

        // è§£ææ¨™é¡Œ
        String[] headers = lines.get(0).split(",");
        Map<String, Integer> headerMap = new HashMap<>();
        for (int i = 0; i < headers.length; i++) {
            headerMap.put(headers[i].trim().toLowerCase(), i); // å¿½ç•¥å¤§å°å¯«ä¸¦å»é™¤ç©ºç™½
        }

        // è§£æè³‡æ–™è¡Œ
        return lines.stream()
                .skip(1) // è·³éæ¨™é ­
                .filter(line -> !line.trim().isEmpty()) // éæ¿¾ç©ºè¡Œ
                .map(line -> {
                    String[] fields = line.split(",");
                    EmployeeDataCSVDto dto = new EmployeeDataCSVDto();

                    // å‹•æ…‹æ˜ å°„å­—æ®µ
                    dto.setID(getFieldValue(fields, headerMap, "ID"));
                    dto.setDEPARTMENT(getFieldValue(fields, headerMap, "DEPARTMENT"));
                    dto.setJOB_TITLE(getFieldValue(fields, headerMap, "JOB_TITLE"));
                    dto.setNAME(getFieldValue(fields, headerMap, "NAME"));
                    dto.setTEL(getFieldValue(fields, headerMap, "TEL"));
                    dto.setEMAIL(getFieldValue(fields, headerMap, "EMAIL"));

                    logger.info("Parsed CSV data: ID={}, DEPARTMENT={}, JOB_TITLE={}, NAME={}, TEL={}, EMAIL={}",
                            dto.getID(), dto.getDEPARTMENT(), dto.getJOB_TITLE(), dto.getNAME(),
                            dto.getTEL(), dto.getEMAIL());
                            
                    return dto;
                })
                .collect(Collectors.toList());
    }

    private String getFieldValue(String[] fields, Map<String, Integer> headerMap, String fieldName) {
        Integer index = headerMap.get(fieldName.toLowerCase());
        return (index != null && index < fields.length) ? fields[index].trim() : null;
    }
}
//æ­¥é©Ÿ8ï¼šCSVè§£æ
------------------------------------------
util/
ã€WebClientUtil       # WebClient é‡è¤‡é‚è¼¯å°è£ã€‘
------------------------------------------
package cdf.training.svc.datatransfer.util;

public class WebClientUtil {
    
}

------------------------------------------
resources/
ã€application.yml             # æ’ç¨‹èˆ‡è¶…æ™‚é…ç½®ã€‘
------------------------------------------
spring:
  application:
    name: training-svc-data-transfer
  datasource:
    url: jdbc:sqlserver://localhost:1433;databaseName=CompanyDataBase;encrypt=false;collation=Chinese_Taiwan_Stroke_CI_AS
    username: sa
    password: 1QAZ2WSX3EDc4@
    driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
server:
  port: 8081
sftp:
  host: localhost
  port: 2222
  username: sa
  password: 1QAZ2WSX3EDc4@
  remote-dir: /upload
logging:
  level:
    root: INFO
    cdf.training.svc.datatransfer: DEBUG
  charset:
    console: UTF-8
# spring:
#   application:
#     name: training-svc-data-transfer
#   datasource:
#     url: jdbc:sqlserver://localhost:1433;databaseName=CompanyDataBase;encrypt=false;collation=Chinese_Taiwan_Stroke_CI_AS
#     username: sa
#     password: 1QAZ2WSX3EDc4@
#     driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
# server:
#   port: 8081
# sftp:
#   host: localhost
#   port: 2222
#   username: sa
#   password: 1QAZ2WSX3EDc4@
#   remote-dir: /upload
# logging:
#   level:
#     root: INFO
#     cdf.training.svc.datatransfer: DEBUG
#   charset:
#     console: UTF-8
------------------------------------------
ã€build.gradleã€‘
------------------------------------------
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.4.3'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'cdf.training.svc'
version = '1.0.0-SNAPSHOT'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(23)
	}
}

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
}

// dependencies {
// 	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
// 	implementation 'org.springframework.boot:spring-boot-starter-web'
// 	implementation 'com.jcraft:jsch:0.1.55'
// 	implementation 'com.opencsv:opencsv:5.9'
// 	implementation 'org.springframework.integration:spring-integration-sftp'
//     implementation 'org.apache.commons:commons-csv:1.8'
// 	compileOnly 'org.projectlombok:lombok'
// 	developmentOnly 'org.springframework.boot:spring-boot-devtools'
// 	runtimeOnly 'com.microsoft.sqlserver:mssql-jdbc'
// 	annotationProcessor 'org.projectlombok:lombok'

// 	// æ¸¬è©¦ä¾è³´
//     testImplementation 'org.springframework.boot:spring-boot-starter-test'
//     testImplementation 'org.mockito:mockito-core:5.12.0'  // Mockito ç”¨æ–¼æ¨¡æ“¬
//     testImplementation 'org.mockito:mockito-junit-jupiter:5.12.0'  // æ”¯æ´ JUnit 5
//     testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
// }

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'com.jcraft:jsch:0.1.55'
    implementation 'com.opencsv:opencsv:5.9'
    implementation 'org.springframework.integration:spring-integration-sftp'
    implementation 'org.apache.commons:commons-csv:1.8'
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:3.0.3'
    //implementation 'org.springframework.boot:spring-boot-starter-jdbc' // æ·»åŠ  JDBC æ”¯æŒ
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.microsoft.sqlserver:mssql-jdbc'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.mockito:mockito-core:5.12.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.12.0'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
}

<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>åˆ†éš”ç·š<><><><><><><><><><>